@using System.Security.Claims

@model ChantingViewModel
@{
    ViewData["Title"] = "Edit Chanting Record";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Edit Sadhana Record</h2>

<form asp-action="Edit" method="post">
    @*  <div class="form-group">
    <div asp-validation-summary="All" class="text-danger"></div>
    </div> *@
    <div class="form-group">
        <label asp-for="Date">Date</label>
        <input asp-for="Date" type="date" class="form-control" required />
    </div>

    <div class="form-group">
        <label asp-for="MorningRounds">Morning Rounds</label>
        <input asp-for="MorningRounds" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="DayRounds">Day Rounds</label>
        <input asp-for="DayRounds" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="EveningRounds">Evening Rounds</label>
        <input asp-for="EveningRounds" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="ReadingTitle">Reading Title</label>
        <input asp-for="ReadingTitle" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="ReadingDurationInMinutes">Reading Duration (in minutes)</label>
        <input asp-for="ReadingDurationInMinutes" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="HearingTitle">Hearing Title</label>
        <input asp-for="HearingTitle" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="HearingDurationInMinutes">Hearing Duration (in minutes)</label>
        <input asp-for="HearingDurationInMinutes" class="form-control" />
    </div>


    <div class="form-floating py-1 col-12">
        <select asp-for="SelectedServiceTypeId" asp-items="ViewBag.ServiceTypeList" class="form-control border shadow" id="serviceDropdown" onchange="toggleCustomServiceTypeInput();">
            <option value="">--Select Service Type--</option>
        </select>
        <label asp-for="SelectedServiceTypeId" class="ms-2">Service Type:</label>
    </div>
    <div class="col-12 mt-2">
        <a href="@Url.Action("Index", "ServiceType")" class="btn btn-outline-primary btn-sm">Manage Service Types</a>
        <small class="text-muted d-block mt-1">Add or edit service types if not listed.</small>
    </div>

    <label asp-for="ServiceDurationInMinutes">Service Duration (in minutes)</label>
    <input asp-for="ServiceDurationInMinutes" class="form-control" />


    <div class="form-group">
        <label asp-for="Notes">Notes</label>
        <textarea asp-for="Notes" class="form-control"></textarea>
    </div>

    <div class="row pt-2">
        <div class="col-6 col-md-3">
            <button type="submit" class="btn btn-success w-100">
                <i class="bi bi-check-circle"></i> Update
            </button>
        </div>
        <div class="col-6 col-md-3">
            <a asp-controller="Sadhana" asp-action="SadhanaHistory" class="btn btn-secondary w-100">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </div>
</form>

<script>
    function saveFormData() {
        var userId = @User.FindFirstValue(ClaimTypes.NameIdentifier);
        var formData = {
            date: $('#Date').val(),
            morningRounds: $('#MorningRounds').val(),
            dayRounds: $('#DayRounds').val(),
            eveningRounds: $('#EveningRounds').val(),
            readingTitle: $('#ReadingTitle').val(),
            readingDurationInMinutes: $('#ReadingDurationInMinutes').val(),
            hearingTitle: $('#HearingTitle').val(),
            hearingDurationInMinutes: $('#HearingDurationInMinutes').val(),
            selectedServiceTypeId: $('#SelectedServiceTypeId').val(),
            serviceDurationInMinutes: $('#ServiceDurationInMinutes').val(),
            notes: $('#Notes').val(),
        };
        localStorage.setItem('sadhanaFormData' + userId, JSON.stringify(formData));
    }

    // Attach event listeners
    $('#Date, #MorningRounds, #DayRounds, #EveningRounds, #ReadingTitle, #ReadingDurationInMinutes, #HearingTitle, #HearingDurationInMinutes, #SelectedServiceTypeId, #ServiceDurationInMinutes, #Notes').change(saveFormData);

    $(document).ready(function () {
        var userId = @User.FindFirstValue(ClaimTypes.NameIdentifier);
        var returningFromServiceTypes = localStorage.getItem('returningFromServiceTypes');

        if (returningFromServiceTypes === 'true') {
            var savedData = localStorage.getItem('sadhanaFormData' + userId);
            if (savedData) {
                var formData = JSON.parse(savedData);
                $('#Date').val(formData.date);
                $('#MorningRounds').val(formData.morningRounds);
                $('#DayRounds').val(formData.dayRounds);
                $('#EveningRounds').val(formData.eveningRounds);
                $('#ReadingTitle').val(formData.readingTitle);
                $('#ReadingDurationInMinutes').val(formData.readingDurationInMinutes);
                $('#HearingTitle').val(formData.hearingTitle);
                $('#HearingDurationInMinutes').val(formData.hearingDurationInMinutes);
                $('#SelectedServiceTypeId').val(formData.selectedServiceTypeId);
                $('#ServiceDurationInMinutes').val(formData.serviceDurationInMinutes);
                $('#Notes').val(formData.notes);
            }
            localStorage.removeItem('returningFromServiceTypes');
        }
        else {
            localStorage.removeItem('sadhanaFormData' + userId);
        }
    });
</script>

        <script>
    $(document).ready(function () {

        // Autocomplete for Reading Title

        $("#ReadingTitle").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '@Url.Action("GetReadingTitles", "Sadhana")',
                    data: { term: request.term },
                    success: function (data) {
                        response(data);
                    }
                });
            },
            minLength: 1, // Start after typing 2 characters
            select: function (event, ui) {
                // Set the input field's value to the selected item's value
                $(this).val(ui.item.value);

                // Additional actions
                // For example, if you want to trigger a form submission or update another part of your UI based on the selection
                // $('#someOtherElement').val(ui.item.someOtherProperty);

                // Prevent the widget from automatically inserting the value into the input field
                return false;
            }
        });

        // Autocomplete for Hearing Title
        $("#HearingTitle").autocomplete({
            source: '@Url.Action("GetHearingTitles", "Sadhana")', // Adjust the URL as needed
            minLength: 1,
            select: function (event, ui) {
                $(this).val(ui.item.value);
                return false;
            }
        });
    });
        </script>

<script>
    $(document).ready(function () {
        $('#infoIconNotes').click(function () {
            $('#notesInfoText').toggle();
        });
    });
</script>